<!DOCTYPE html>

{{template "/_head.html"}}
<title>Home</title>

<main class="group flex flex-row w-full h-full bg-white">
  <div class="md:w-64 flex-none w-full px-4 py-6">
    <div class="flex mb-6">
      <a class="p-3 text-lg text-center text-gray-600 bg-gray-100 rounded-lg" href="/">XRss</a>
      <span
        class="md:hidden right-0 w-10 h-10 h-full p-3 ml-auto text-lg leading-none text-gray-600 bg-gray-100 rounded-lg">➜</span>
    </div>
    <ul id="feeds-list" class="space-y-1">
      {{range .QueryRows `SELECT id, url, title, image FROM v_feed`}}
      {{block "feed" .}}
      <li class="overflow-hidden">
        <a hx-post="/feeds/feed/{{.id}}/fetch" hx-swap="none"
          class="block px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg">{{.title}}</a>
      </li>
      {{end}}
      {{end}}
    </ul>
    <div class="sticky inset-x-0 bottom-0 border-t border-gray-100">
      {{block "newfeed" .}}
      <input type="text" id="feedurl" name="feedurl" placeholder="Add a new feed" required
        hx-post="/feeds/new" hx-target="#feeds-list" hx-swap="afterbegin"
        class="input input-sm w-full" value="" />
      {{end}}
    </div>
  </div>

  <div class="flex-1 min-w-0 px-4 py-6">
    <div class="flex mb-6">
      <span
        class="md:hidden w-10 h-10 p-3 ml-auto text-lg leading-none text-gray-600 bg-gray-100 rounded-lg">➜</span>
      <a class="p-3 text-lg text-center text-gray-600 bg-gray-100 rounded-lg" href="/">Category</a>
    </div>
    <ul id="article-list">
      {{- block "feed_items" .}}
      {{- $offset := int (.Req.URL.Query.Get "offset") }}
      {{- range .QueryRows `SELECT id, feed_title, title, description, image, author, published FROM v_item LIMIT 10 OFFSET $1` $offset }}
      <li class="odd:bg-gray-100 h-[6em] flex flex-row gap-2 p-2">
        <div class="flex-none w-[5em] bg-cover rounded" style="background-image: url('{{.image}}');"></div>
        <div class="flow-root overflow-hidden">
          <div class="flex flex-row items-baseline">
            <div class="flex-initial pr-1 text-lg font-semibold truncate">{{.title | stripHTML | trustHtml}}</div>·
            <div class="flex-none pl-1 pr-1 text-sm text-gray-800">{{.author}}</div>·
            <div class="group/tip relative flex-none pl-1 text-sm text-gray-800">
              <time datetime="{{.published}}">{{.published | humanize "time:2006-01-02T15:04:05Z07:00"}}</time>
              <span
                class="group-hover/tip:visible left-full top-full mr-[-999px] -translate-x-full group-hover:z-50 absolute invisible p-1 top-full text-gray-200 bg-gray-800 rounded shadow-lg">
                {{- .published | toDate "2006-01-02T15:04:05Z07:00" | date "Monday, 02 Jan 2006 15:04:05 MST" -}}
              </span>
            </div>
          </div>
          <div class="line-clamp-2 text-gray-500">{{.description | stripHTML | abbrev 2000 | trustHtml}}</div>
        </div>
      </li>
      {{- end}}
      <li hx-trigger="revealed" hx-swap="outerHTML" hx-get="items?offset={{ add $offset 10 }}">(loading...)</li>
      {{- end}}
    </ul>
  </div>
</main>

<footer class="sticky inset-x-0 bottom-0">
  {{- $stats := .QueryStats -}}
  Performed {{$stats.Count}} queries in {{$stats.TotalDuration.Round 10000}}.
</footer>

{{- define "GET /items"}}
{{- template "feed_items" .}}
{{- end}}

{{- define "POST /feeds/new"}}
{{- $url := .Req.PostForm.feedurl | idx 0}}
{{- $feed_id := (.Exec `INSERT INTO feed(url) VALUES(($1))` $url).LastInsertId }}
{{- template "fetch_feed" .WithVars (dict "feed_id" $feed_id) }}
{{- template "feed" .QueryRow `SELECT id, url, title FROM feed WHERE id=?` $feed_id}}
{{- end}}

{{- define "POST /feeds/feed/:id/fetch"}}
{{- template "fetch_feed" .WithVars (dict "feed_id" (.Params.ByName "id")) }}
{{- end}}

{{- define "fetch_feed"}}
{{- $feed_id := .Vars.feed_id }}
{{- $feed := .QueryRow `SELECT feed_id, url, last_modified, etag FROM v_feed_fetch_info WHERE feed_id=$1` $feed_id}}
{{- $response :=  try .Funcs.fetchFeed $feed.url $feed.etag $feed.last_modified}}
{{- if $response.OK }}
{{- $result := .Exec `INSERT INTO ingest(feed_id, data) VALUES ($1, $2)` $feed_id (toJson $response.Value) }}
{{- else }}
Failed to fetch rss feed: {{$response.Error}}
{{- end}}
{{- end}}