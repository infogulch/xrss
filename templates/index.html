{{template "/_head.html"}}
<title>Home</title>

<main>
	<style data-scoped>
		:scope { display: flex; flex-direction: row-reverse; overflow-x: scroll; background-color: #ffffff; scroll-snap-type: x mandatory; width: 100vw; height: 100vh; scrollbar-width: none; }
	</style>

	{{- block "items-panel" .}}
	{{- $feed_id := int (.Params.ByName "feed_id") }}
	<section id="items-panel">
		<style data-scoped>
			:scope { flex-shrink: 0; width: 100%; min-width: 0; height: 100%; scroll-snap-align: start; scrollbar-gutter: stable; }
			:scope { @media (min-width: 768px) { flex: 1 1 0%; } }

			:scope ol { padding: 0.5rem; }
			:scope ol > li { background-color: white; }
			:scope ol > li:nth-child(2n+1) { background-color: #F3F4F6; }

			:scope li > div { display: flex; padding: 0.5rem; flex-direction: row; gap: 0.5rem; cursor: pointer; height: 7.5em; background-color: inherit; }
			:scope li > div img { margin: 0.25rem; flex: none; border-radius: 0; object-fit: cover; width: 6em; height: 6em; }
			:scope li > div div { display: flow-root; overflow: hidden; }
			:scope li > div h3 {padding-right: 0.5rem; flex: 0 1 auto; font-size: 1.125rem; line-height: 1.75rem; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
			:scope li > div p { color: #6B7280; overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
			:scope li > div ul { display: flex; flex-direction: row; flex: none; align-items: baseline; }
			:scope li > div ul li { padding-right: 0.25rem; flex: none; font-size: 0.875rem; line-height: 1.25rem; color: #1F2937; }
			:scope li > div ul li + li { list-style-type: "·"; margin-left: 0.25rem; padding-left: 0.25rem; }
			:scope li > div dl { margin-top: 1rem; }
			:scope li > div dt { display:inline; padding: 0.375rem; margin: 0.25rem; border-radius: 0.5rem; font-size: 0.875rem; line-height: 1.25rem; white-space: nowrap; background-color: #D1D5DB; }

			:scope li .expanded { position: sticky; top: 3.5rem; }

			:scope li article { margin: 2rem; max-width: 56rem; padding: 1rem; }

			:scope .tip { position: relative; }
			:scope .tip span { visibility:hidden; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-right: -999px; padding: 0.25rem; border-radius: 0.25rem; color: #E5E7EB; background-color: #1F2937; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
			:scope .tip:hover span { visibility:visible; }
		</style>
		<header>
			<style data-scoped>
				:scope { display: flex; position: sticky; top: 0; padding: 0.5rem; z-index: 20; gap: 0.5rem; width: 100%; background-color: #ffffff; }
				:scope * { border-radius: 0.5rem; height: 100%; padding: 0.75rem; font-size: 1.125rem; line-height: 1.75rem; color: #4B5563; background-color: #F3F4F6; }
				:scope .mobile { @media (min-width: 768px) { display: none; } }
			</style>
			<button class="mobile" onclick="scrollElementIntoView('#feeds-panel')">&nbsp;⇌&nbsp;</button>
			<h2>{{.QueryVal `SELECT COALESCE((SELECT title FROM v_feed WHERE id=$1), 'All Feeds')` $feed_id}}</h2>
			{{- if and (ne $feed_id 0) (not .Config.read_only)}}
			<button hx-post="/feeds/{{$feed_id}}/refresh" hx-target="#items-panel" hx-swap="outerHTML scroll:top">⟳</button>
			{{- end}}
		</header>
		<ol id="items">
			{{- block "items" .}}
			{{- $feed_id := int (.Params.ByName "feed_id") }}
			{{- $offset := int (.Req.URL.Query.Get "offset") }}
			{{- $count := .QueryVal `SELECT COUNT(*) FROM v_item WHERE feed_id=$1 OR $1=0` $feed_id}}
			{{- range .QueryRows `SELECT feed_id, id, feed_title, title, description, image, author, published, 'expanded' AS expanded FROM v_item WHERE feed_id=$1 OR $1=0 ORDER BY published DESC LIMIT 10 OFFSET $2` $feed_id $offset }}
			{{- block "item" .}}
			<li>
				<div hx-get="/feeds/{{.feed_id}}/items/{{.id}}/{{.expanded}}" hx-swap="outerHTML transition:true" hx-target="closest li">
					<img src="{{.image}}">
					<div>
						<h3>{{.title | sanitizeHtml "strict" }}</h3>
						<ul>
							<li>{{.feed_title | sanitizeHtml "strict" }}</li>
							<li>{{.author | sanitizeHtml "strict" }}</li>
							<li class="tip">
								<time datetime="{{.published}}">{{.published | humanize "time:2006-01-02T15:04:05Z07:00"}}</time>
								<span>{{- .published | toDate "2006-01-02T15:04:05Z07:00" | date "Monday, 02 Jan 2006 15:04:05 MST" -}}</span>
							</li>
						</ul>
						{{if .categories}}<dl>{{range (.categories | mustFromJson)}}<dt>{{.}}</dt>{{end}}</dl>{{end}}
						{{if .description}}<p>{{.description | abbrev 4000 | sanitizeHtml "strict"}}</p>{{end}}
					</div>
				</div>
				{{if .content}}<article>{{- sanitizeHtml "externalugc" .content }}</article>{{end}}
			</li>
			{{- end}}
			{{- end}}
			{{- $next_offset := add $offset 10}}
			{{- if lt $next_offset $count}}
			<li hx-trigger="intersect once" hx-swap="outerHTML" hx-get="{{if $feed_id }}/feeds/{{$feed_id}}{{end}}/items?offset={{ $next_offset }}">(loading...)</li>
			{{- end}}
			{{- end}}
		</ol>
	</section>
	{{- end}}

	<!-- render feeds panel last + main flex-direction: row-reverse so #perf renders after all queries. yes that's kinda quirky. -->
	<section id="feeds-panel">
		<style data-scoped>
			:scope { display: flex; overflow-y: auto; padding: 0.5rem; flex-direction: column; flex-shrink: 0; width: 100%; height: 100%; scroll-snap-align: start; scrollbar-gutter: stable; }
			:scope { @media (min-width: 768px) { width: 16rem; } }

			:scope header { display: flex; margin-bottom: 1.5rem; }
			:scope header span { padding: 0.75rem; border-radius: 0.5rem; font-size: 1.125rem; line-height: 1.75rem; text-align: center; color: #4B5563; background-color: #F3F4F6; }
			:scope header button { right: 0; padding: 0.75rem; margin-left: auto; border-radius: 0.5rem; height: 100%; font-size: 1.125rem; line-height: 1.75rem; color: #4B5563; background-color: #F3F4F6; }
			:scope header button { @media (min-width: 768px) { display: none; } }

			:scope li+li { margin-top: 0.25rem; }
			:scope li { overflow: hidden; }

			:scope li a { display: flex; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; line-height: 1.25rem; font-weight: 500; color: #374151; background-color: #F3F4F6; }
			:scope li a img { margin-right: 0.25rem; width: 1.25rem; height: 1.25rem; }
			:scope li a span { margin-right: 0.25rem; border-radius: 0.125rem; width: 1.25rem; height: 1.25rem; font-family: Georgia, Cambria, "Times New Roman", Times, serif; font-weight: 700; text-align: center; background-color: #1F2937; }

			:scope footer { right: 0; left: 0; bottom: 0; margin-top: auto; }
			:scope input { width: 100%; }
		</style>
		<header>
			<span>XRss</span>
			<button onclick="scrollElementIntoView('#items-panel')">&nbsp;⇌&nbsp;</button>
		</header>
		<ol id="feeds-list">
			<li><a href="/" hx-get="/" hx-target="body" hx-push-url="true" hx-swap="outerHTML show:#items-panel:top">All Feeds</a></li>
			{{- range .QueryRows `SELECT id, url, title, image FROM v_feed`}}
			{{- block "feed" .}}
			<li>
				<a hx-get="/feeds/{{.id}}/" hx-target="#items-panel" hx-swap="outerHTML show:top" hx-push-url="true" href="/feed/{{.id}}/">
					{{- if .image}}<img src="{{.image}}">{{- else}}<span>{{.title | substr 0 1 | upper}}</span>{{end}}
					{{- .title -}}
				</a>
			</li>
			{{- end}}
			{{- end}}
		</ol>
		<footer>
			{{- block "newfeed" .}}
			{{- if not .Config.read_only}}
			<input type="text" id="feedurl" name="feedurl" placeholder="Add a new feed" value="" required
				hx-post="/feeds" hx-target="#feeds-list" hx-swap="beforeend" />
			{{- end}}
			{{- end}}
			{{- block "perf" .}}
			<div id="perf" hx-swap-oob="true" hx-swap="outerHTML" hx-target="#perf">
				{{- $stats := .QueryStats -}}
				Performed {{$stats.Count}} {{$stats.Count | plural "query" "queries"}} in {{$stats.TotalDuration.Round 10000}}.
			</div>
			{{- end}}
		</footer>
	</section>
</main>

{{- define "GET /feeds/:feed_id/"}}
{{- if (.Req.Header.Get "HX-Request")}}
{{- template "items-panel" .}}
{{- template "perf" .}}
{{- else}}
{{- template "/index.html" .}}
{{- end}}
{{- end}}

{{- define "GET /items"}}
{{- template "items" .}}
{{- template "perf" .}}
{{- end}}

{{- define "GET /feeds/:feed_id/items"}}
{{- template "items" .}}
{{- template "perf" .}}
{{- end}}

{{- define "GET /feeds/:feed_id/items/:item_id/"}}
{{- $item := .QueryRow `SELECT feed_id, id, feed_title, title, description, image, author, published, 'expanded' AS expanded FROM v_item WHERE feed_id=$1 AND id=$2` (.Params.ByName "feed_id") (.Params.ByName "item_id") }}
{{- template "item" $item}}
{{- template "perf" .}}
{{- end}}

{{- define "GET /feeds/:feed_id/items/:item_id/expanded"}}
{{- $feed_id := .Params.ByName "feed_id" }}
{{- $item_id := .Params.ByName "item_id" }}
{{- $item := .QueryRow `SELECT feed_id, id, feed_title, title, link, image, author, published, categories, content, '' AS expanded FROM v_item WHERE feed_id = $1 AND id = $2` $feed_id $item_id }}
{{- template "item" $item}}
{{- template "perf" .}}
{{- end}}

{{- define "POST /feeds"}}
{{- if .Config.read_only}}
{{- httpError 403 }}
{{- end}}
{{- $url := .Req.PostForm.feedurl | idx 0}}
{{- $feed_id := (.Exec `INSERT INTO feed(url) VALUES(($1))` $url).LastInsertId }}
{{- template "fetch_feed" .WithVars (dict "feed_id" $feed_id) }}
{{- template "feed" .QueryRow `SELECT id, url, title FROM v_feed WHERE id=?` $feed_id}}
{{- end}}

{{- define "POST /feeds/:feed_id/refresh"}}
{{- if .Config.read_only}}
{{- httpError 403 }}
{{- end}}
{{- template "fetch_feed" .WithVars (dict "feed_id" (.Params.ByName "feed_id")) }}
{{- template "GET /feeds/:feed_id/" .}}
{{- end}}

{{- define "fetch_feed"}}
{{- $feed_id := .Vars.feed_id }}
{{- $feed := .QueryRow `SELECT feed_id, url, last_modified, etag FROM v_feed_fetch_info WHERE feed_id=$1` $feed_id}}
{{- $response :=  try .Funcs.fetchFeed $feed.url $feed.etag $feed.last_modified}}
{{- if $response.OK }}
{{- $result := .Exec `INSERT INTO ingest(feed_id, data) VALUES ($1, $2)` $feed_id (toJson $response.Value) }}
{{- else }}
Failed to fetch rss feed: {{$response.Error}}
{{- httpError 502 }}
{{- end}}
{{- end}}
